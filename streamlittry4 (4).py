# -*- coding: utf-8 -*-
"""streamlittry4

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1UZ6l6_ydFfzo6VJVAlNXJQQ61p9dJgpz
"""

import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from datetime import datetime, timedelta
from scipy.stats import norm
from scipy.optimize import fsolve

# ================= Streamlit Sidebar Inputs =================
st.sidebar.title("Options Analysis Dashboard")
ticker = st.sidebar.text_input("Ticker", value="AAPL")
expiry_count = st.sidebar.slider("Expiry Count", 1, 10, 3)
forecast_days = st.sidebar.slider("Forecast Days", 10, 90, 30)
E = st.sidebar.slider("E (Pinning)", 0.001, 0.05, 0.01)
opt_type = st.sidebar.selectbox("Option Type", ["Put", "Call"])

# Ensure ticker is valid before fetching data
if ticker:
    stock = yf.Ticker(ticker)
    try:
        expirations = stock.options
        st.sidebar.write("Available Expiries:", expirations)
        selected_expiries = st.sidebar.multiselect("Select Expiries for Analysis", expirations, default=expirations[:expiry_count])
        valuation_expiry = st.sidebar.selectbox("Select Expiry for Valuation", expirations)
    except Exception as e:
        st.error(f"Error fetching options data: {e}")
        selected_expiries, valuation_expiry = [], None
else:
    st.stop()

# ================= Black-Scholes Option Pricing =================
def black_scholes_price(S, K, T, r, sigma, option_type='call'):
    d1 = (np.log(S / K) + (r + 0.5 * sigma ** 2) * T) / (sigma * np.sqrt(T))
    d2 = d1 - sigma * np.sqrt(T)
    if option_type.lower() == 'call':
        return S * norm.cdf(d1) - K * np.exp(-r * T) * norm.cdf(d2)
    else:
        return K * np.exp(-r * T) * norm.cdf(-d2) - S * norm.cdf(-d1)

# ================= Generate Detailed Report =================
def generate_option_report(ticker, expiries, max_pain_prices, pinning_probs,
                           bs_call, bs_put, earnings_move, vol_skew_rr,
                           call_iv, put_iv, current_price, forecast_days=30):
    report = f"ğŸ“Š **Option Market Analysis Report: {ticker}**\n\n"
    avg_max_pain = np.mean(max_pain_prices)
    expiry_str = ", ".join(expiries)

    # 1ï¸âƒ£ Max Pain
    report += f"1ï¸âƒ£ **Max Pain (æœ€å¤§ç—›ç‚¹ä»·):**\n"
    report += f"- åˆ°æœŸæ—¥åˆ†åˆ«ä¸º {expiries} çš„ Max Pain ä»·æ ¼: {max_pain_prices}\n"
    report += f"- å¹³å‡æœ€å¤§ç—›ç‚¹ä»·çº¦ä¸º **${avg_max_pain:.2f}**ï¼Œå½“å‰è‚¡ä»·ä¸º **${current_price:.2f}**ã€‚\n"
    report += f"â³ **ä¿è´¨æœŸ:** åŸºäºä¸Šè¿°åˆ°æœŸæ—¥çš„æœŸæƒç»“æ„ï¼Œæœ‰æ•ˆæœŸè‡³æœ€è¿‘çš„åˆ°æœŸæ—¥ {expiries[0]}ã€‚\n"
    if current_price > avg_max_pain:
        report += "ğŸ‘‰ è‚¡ä»·é«˜äºå¹³å‡ç—›ç‚¹ä»·ï¼ŒçŸ­æœŸæœ‰ä¸‹è¡Œå›å½’å‹åŠ›ã€‚\n\n"
    else:
        report += "ğŸ‘‰ è‚¡ä»·ä½äºå¹³å‡ç—›ç‚¹ä»·ï¼Œå¯èƒ½å‘ä¸Šå›å½’è‡³ç—›ç‚¹æ°´å¹³ã€‚\n\n"

    # 2ï¸âƒ£ Pinning Probability
    report += "2ï¸âƒ£ **Pinning Probability (é’‰ä½æ¦‚ç‡):**\n"
    for e, p in zip(expiries, pinning_probs):
        report += f"- {e}: é’‰ä½æ¦‚ç‡ **{p*100:.2f}%**\n"
    report += f"â³ **ä¿è´¨æœŸ:** é’‰ä½æ¦‚ç‡é¢„æµ‹ä»…é€‚ç”¨äºå„è‡ªçš„åˆ°æœŸæ—¥ ({expiry_str})ã€‚\n\n"

    # 3ï¸âƒ£ Black-Scholes Pricing
    report += f"3ï¸âƒ£ **Black-Scholes å®šä»·:**\n- Call **${bs_call:.2f}**ï¼ŒPut **${bs_put:.2f}**ã€‚\nâ³ **ä¿è´¨æœŸ:** å³æœŸä¼°å€¼ï¼Œéœ€æ¯æ—¥æ›´æ–°ã€‚\n\n"

    # 4ï¸âƒ£ Earnings Expected Move
    price_lower = current_price * (1 - earnings_move/100)
    price_upper = current_price * (1 + earnings_move/100)
    report += f"4ï¸âƒ£ **Earnings Expected Move (è´¢æŠ¥é¢„æœŸæ³¢åŠ¨):**\n- éšå«æ³¢åŠ¨åŒºé—´ Â±{earnings_move:.2f}%: **${price_lower:.2f} - ${price_upper:.2f}**ã€‚\nâ³ **ä¿è´¨æœŸ:** è´¢æŠ¥æ—¥å‰åçº¦1å‘¨ã€‚\n\n"

    # 5ï¸âƒ£ Vol Skew & RR
    report += f"5ï¸âƒ£ **Vol Skew & Risk Reversal:**\n- Call IV: **{call_iv:.2f}%**, Put IV: **{put_iv:.2f}%**ã€‚\n- RR: **{vol_skew_rr:.2f}%** ({'çœ‹æ¶¨' if vol_skew_rr>0 else 'çœ‹è·Œ/é˜²å¾¡'}).\n\n"

    # 6ï¸âƒ£ Forecast
    forecast_lower = current_price * (1 + vol_skew_rr/200 - earnings_move/200)
    forecast_upper = current_price * (1 - vol_skew_rr/200 + earnings_move/200)
    expiry_date = (datetime.today() + timedelta(days=forecast_days)).strftime("%Y-%m-%d")
    report += f"6ï¸âƒ£ **{forecast_days}å¤©ä»·æ ¼é¢„æµ‹åŒºé—´:**\n- **${forecast_lower:.2f} - ${forecast_upper:.2f}**ã€‚\nâ³ **ä¿è´¨æœŸ:** è‡³ **{expiry_date}**ã€‚\n\n---\nğŸ“Œ **ç»“è®º:** å¸‚åœº{'é˜²å¾¡/çœ‹è·Œ' if vol_skew_rr<0 else 'åå¤š'}ï¼Œå»ºè®®ç›¸åº”ç­–ç•¥å¸ƒå±€ã€‚"

    return report

# ================= Run Analysis =================
if st.sidebar.button("Run Analysis"):
    hist = stock.history(period="1d")
    if hist.empty:
        st.error("No historical data available. Check ticker.")
    else:
        current_price = hist["Close"].iloc[-1]
        # Placeholder data for demonstration
        max_pain_prices = [current_price - 2 for _ in selected_expiries]
        pinning_probs = [0.012 for _ in selected_expiries]
        bs_call, bs_put = 7.43, 6.94
        earnings_move = 4.17
        vol_skew_rr, call_iv, put_iv = -13.09, 67.19, 80.27

        # Generate Report
        report = generate_option_report(ticker, selected_expiries, max_pain_prices, pinning_probs,
                                        bs_call, bs_put, earnings_move, vol_skew_rr,
                                        call_iv, put_iv, current_price, forecast_days)
        st.markdown(report)

        # Anticipation Plot
        days = np.arange(0, forecast_days+1)
        max_pain_path = np.linspace(current_price, np.mean(max_pain_prices), len(days))
        bs_path = np.linspace(current_price, current_price * (1 + vol_skew_rr/200), len(days))
        avg_path = (max_pain_path + bs_path) / 2

        fig, ax = plt.subplots(figsize=(10, 6))
        ax.plot(days, max_pain_path, label="Max Pain Path")
        ax.plot(days, bs_path, label="BS Path")
        ax.plot(days, avg_path, label="Average Path", linestyle="--")
        ax.set_title("Price Anticipation Plot")
        ax.set_xlabel("Days")
        ax.set_ylabel("Price")
        ax.legend()
        st.pyplot(fig)
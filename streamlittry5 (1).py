# -*- coding: utf-8 -*-
"""streamlittry5

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/14hvwpG5eq6bbkpVXWxWdLAWe6KoHmDuq
"""

import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from datetime import datetime, timedelta
from scipy.stats import norm
from scipy.optimize import fsolve, curve_fit

# ================= Streamlit Sidebar Inputs =================
st.sidebar.title("Options Analysis Dashboard")
ticker = st.sidebar.text_input("Ticker", value="AAPL")
expiry_count = st.sidebar.slider("Expiry Count", 1, 10, 3)
forecast_days = st.sidebar.slider("Forecast Days", 10, 90, 30)
E = st.sidebar.slider("E (Pinning)", 0.001, 0.05, 0.01)
opt_type = st.sidebar.selectbox("Option Type", ["Put", "Call"])

# Ensure ticker is valid before fetching data
if ticker:
    stock = yf.Ticker(ticker)
    try:
        expirations = stock.options
        st.sidebar.write("Available Expiries:", expirations)
        selected_expiries = st.sidebar.multiselect("Select Expiries for Analysis", expirations, default=expirations[:expiry_count])
        valuation_expiry = st.sidebar.selectbox("Select Expiry for Valuation", expirations)
    except Exception as e:
        st.error(f"Error fetching options data: {e}")
        selected_expiries, valuation_expiry = [], None
else:
    st.stop()

# ================= Option Builder =================
st.sidebar.subheader("Option Strategy Builder")
strategy = st.sidebar.selectbox("Select Strategy", ["Single Call", "Single Put", "Vertical Spread", "Straddle"])
strike_price = st.sidebar.number_input("Strike Price", min_value=1.0, value=100.0)
premium = st.sidebar.number_input("Option Premium", min_value=0.0, value=5.0)

if strategy == "Vertical Spread":
    strike_price_2 = st.sidebar.number_input("Second Strike Price", min_value=1.0, value=105.0)
    premium_2 = st.sidebar.number_input("Second Option Premium", min_value=0.0, value=3.0)

if st.sidebar.button("Build Option"):
    price_range = np.linspace(strike_price * 0.8, strike_price * 1.2, 100)
    payoff = None
    if strategy == "Single Call":
        payoff = np.maximum(price_range - strike_price, 0) - premium
    elif strategy == "Single Put":
        payoff = np.maximum(strike_price - price_range, 0) - premium
    elif strategy == "Vertical Spread":
        payoff = (np.maximum(price_range - strike_price, 0) - premium) - (np.maximum(price_range - strike_price_2, 0) - premium_2)
    elif strategy == "Straddle":
        payoff = (np.maximum(price_range - strike_price, 0) - premium) + (np.maximum(strike_price - price_range, 0) - premium)

    fig, ax = plt.subplots(figsize=(8, 4))
    ax.plot(price_range, payoff, label=strategy)
    ax.axhline(0, color='black', linestyle='--')
    ax.set_title(f"Payoff Diagram: {strategy}")
    ax.set_xlabel("Underlying Price")
    ax.set_ylabel("Profit / Loss")
    ax.legend()
    st.pyplot(fig)

# ================= Black-Scholes Option Pricing =================
def black_scholes_price(S, K, T, r, sigma, option_type='call'):
    d1 = (np.log(S / K) + (r + 0.5 * sigma ** 2) * T) / (sigma * np.sqrt(T))
    d2 = d1 - sigma * np.sqrt(T)
    if option_type.lower() == 'call':
        return S * norm.cdf(d1) - K * np.exp(-r * T) * norm.cdf(d2)
    else:
        return K * np.exp(-r * T) * norm.cdf(-d2) - S * norm.cdf(-d1)

# ================= Fetch Stock Data =================
def fetch_stock_data(ticker, period="6mo", interval="1h"):
    data = yf.download(ticker, period=period, interval=interval)
    if data.empty:
        st.warning(f"[é”™è¯¯] æ— æ³•è·å– {ticker} çš„è‚¡ç¥¨æ•°æ®ï¼Œè¯·æ£€æŸ¥ä»£ç æˆ–ç½‘ç»œè¿æ¥ã€‚")
        return pd.DataFrame()
    data.reset_index(inplace=True)
    return data

# ================= Volume Profile Calculation =================
def compute_volume_profile(data, bins=50):
    if data.empty:
        st.warning("[è­¦å‘Š] è‚¡ç¥¨æ•°æ®ä¸ºç©ºï¼Œæ— æ³•è®¡ç®— Volume Profile")
        return None, None, None, None, None

    hist, edges = np.histogram(data['Close'], bins=bins, weights=data['Volume'])
    if hist.sum() == 0:
        st.warning("[è­¦å‘Š] æˆäº¤é‡ä¸º0ï¼Œæ— æ³•è®¡ç®—POC/VA")
        return None, None, None, hist, edges

    poc_idx = np.argmax(hist)
    poc_price = (edges[poc_idx] + edges[poc_idx+1]) / 2

    sorted_idx = np.argsort(hist)[::-1]
    cum_vol = np.cumsum(hist[sorted_idx])
    total_vol = cum_vol[-1]
    value_area_idx = sorted_idx[cum_vol <= total_vol * 0.7]
    value_area_prices = [(edges[i]+edges[i+1])/2 for i in value_area_idx]

    vah, val = max(value_area_prices), min(value_area_prices)
    return poc_price, vah, val, hist, edges

# ================= Volume Power-Law Fit =================
def power_law(x, a, b):
    return a * np.power(x, -b)

def fit_power_law(volumes):
    volumes = np.array(volumes)
    volumes = volumes[volumes > 0]
    if len(volumes) < 10:
        st.warning("[è­¦å‘Š] æˆäº¤é‡æ ·æœ¬ä¸è¶³ï¼Œæ— æ³•æ‹Ÿåˆå¹‚å¾‹åˆ†å¸ƒ")
        return (np.nan, np.nan), np.array([]), np.array([])

    hist, edges = np.histogram(volumes, bins=50)
    x = (edges[:-1] + edges[1:]) / 2
    y = hist / sum(hist)
    mask = (y > 0)
    popt, _ = curve_fit(lambda x,a,b: a*x**-b, x[mask], y[mask], maxfev=5000)
    return popt, x, y

# ================= Generate Detailed Report =================
def generate_option_report(ticker, expiries, max_pain_prices, pinning_probs,
                           bs_call, bs_put, earnings_move, vol_skew_rr,
                           call_iv, put_iv, current_price, forecast_days=30):
    report = f"ğŸ“Š **Option Market Analysis Report: {ticker}**\n\n"
    avg_max_pain = np.mean(max_pain_prices)
    expiry_str = ", ".join(expiries)

    report += f"1ï¸âƒ£ **Max Pain (æœ€å¤§ç—›ç‚¹ä»·):**\n"
    report += f"- åˆ°æœŸæ—¥åˆ†åˆ«ä¸º {expiries} çš„ Max Pain ä»·æ ¼: {max_pain_prices}\n"
    report += f"- å¹³å‡æœ€å¤§ç—›ç‚¹ä»·çº¦ä¸º **${avg_max_pain:.2f}**ï¼Œå½“å‰è‚¡ä»·ä¸º **${current_price:.2f}**ã€‚\n"
    report += f"â³ **ä¿è´¨æœŸ:** åŸºäºä¸Šè¿°åˆ°æœŸæ—¥çš„æœŸæƒç»“æ„ï¼Œæœ‰æ•ˆæœŸè‡³æœ€è¿‘çš„åˆ°æœŸæ—¥ {expiries[0]}ã€‚\n"
    if current_price > avg_max_pain:
        report += "ğŸ‘‰ è‚¡ä»·é«˜äºå¹³å‡ç—›ç‚¹ä»·ï¼ŒçŸ­æœŸæœ‰ä¸‹è¡Œå›å½’å‹åŠ›ã€‚\n\n"
    else:
        report += "ğŸ‘‰ è‚¡ä»·ä½äºå¹³å‡ç—›ç‚¹ä»·ï¼Œå¯èƒ½å‘ä¸Šå›å½’è‡³ç—›ç‚¹æ°´å¹³ã€‚\n\n"

    report += "2ï¸âƒ£ **Pinning Probability (é’‰ä½æ¦‚ç‡):**\n"
    for e, p in zip(expiries, pinning_probs):
        report += f"- {e}: é’‰ä½æ¦‚ç‡ **{p*100:.2f}%**\n"
    report += f"â³ **ä¿è´¨æœŸ:** é’‰ä½æ¦‚ç‡é¢„æµ‹ä»…é€‚ç”¨äºå„è‡ªçš„åˆ°æœŸæ—¥ ({expiry_str})ã€‚\n\n"

    report += f"3ï¸âƒ£ **Black-Scholes å®šä»·:**\n- Call **${bs_call:.2f}**ï¼ŒPut **${bs_put:.2f}**ã€‚\nâ³ **ä¿è´¨æœŸ:** å³æœŸä¼°å€¼ï¼Œéœ€æ¯æ—¥æ›´æ–°ã€‚\n\n"

    price_lower = current_price * (1 - earnings_move/100)
    price_upper = current_price * (1 + earnings_move/100)
    report += f"4ï¸âƒ£ **Earnings Expected Move (è´¢æŠ¥é¢„æœŸæ³¢åŠ¨):**\n- éšå«æ³¢åŠ¨åŒºé—´ Â±{earnings_move:.2f}%: **${price_lower:.2f} - ${price_upper:.2f}**ã€‚\nâ³ **ä¿è´¨æœŸ:** è´¢æŠ¥æ—¥å‰åçº¦1å‘¨ã€‚\n\n"

    report += f"5ï¸âƒ£ **Vol Skew & Risk Reversal:**\n- Call IV: **{call_iv:.2f}%**, Put IV: **{put_iv:.2f}%**ã€‚\n- RR: **{vol_skew_rr:.2f}%** ({'çœ‹æ¶¨' if vol_skew_rr>0 else 'çœ‹è·Œ/é˜²å¾¡'}).\n\n"

    forecast_lower = current_price * (1 + vol_skew_rr/200 - earnings_move/200)
    forecast_upper = current_price * (1 - vol_skew_rr/200 + earnings_move/200)
    expiry_date = (datetime.today() + timedelta(days=forecast_days)).strftime("%Y-%m-%d")
    report += f"6ï¸âƒ£ **{forecast_days}å¤©ä»·æ ¼é¢„æµ‹åŒºé—´:**\n- **${forecast_lower:.2f} - ${forecast_upper:.2f}**ã€‚\nâ³ **ä¿è´¨æœŸ:** è‡³ **{expiry_date}**ã€‚\n\n---\nğŸ“Œ **ç»“è®º:** å¸‚åœº{'é˜²å¾¡/çœ‹è·Œ' if vol_skew_rr<0 else 'åå¤š'}ï¼Œå»ºè®®ç›¸åº”ç­–ç•¥å¸ƒå±€ã€‚"

    return report
def generate_option_report(
    ticker, expiries, max_pain_prices, pinning_probs,
    bs_call, bs_put, earnings_move, vol_skew_rr,
    call_iv, put_iv, current_price,
    poc, vah, val, max_call, max_put,
    forecast_days=30
):
    report = f"ğŸ“Š **Option Market Analysis Report: {ticker}**\n\n"
    avg_max_pain = np.mean(max_pain_prices)
    expiry_str = ", ".join(expiries)

    report += "1ï¸âƒ£ **Max Pain (æœ€å¤§ç—›ç‚¹ä»·):**\n"
    report += f"- åˆ°æœŸæ—¥åˆ†åˆ«ä¸º {expiries} çš„ Max Pain ä»·æ ¼: {max_pain_prices}\n"
    report += f"- å¹³å‡æœ€å¤§ç—›ç‚¹ä»·çº¦ä¸º **${avg_max_pain:.2f}**ï¼Œå½“å‰è‚¡ä»·ä¸º **${current_price:.2f}**ã€‚\n"
    report += f"â³ **ä¿è´¨æœŸ:** æœ‰æ•ˆæœŸè‡³ {expiries[0]}ã€‚\n\n"

    report += "2ï¸âƒ£ **Pinning Probability (é’‰ä½æ¦‚ç‡):**\n"
    for e, p in zip(expiries, pinning_probs):
        report += f"- {e}: {p*100:.2f}%\n"
    report += f"â³ ä»…é€‚ç”¨äºåˆ°æœŸæ—¥ ({expiry_str})ã€‚\n\n"

    report += "3ï¸âƒ£ **Black-Scholes å®šä»·:**\n"
    report += f"- Call: ${bs_call:.2f}, Put: ${bs_put:.2f}ã€‚\nâ³ å³æœŸä¼°å€¼ï¼Œéœ€æ¯æ—¥æ›´æ–°ã€‚\n\n"

    low, high = current_price*(1-earnings_move/100), current_price*(1+earnings_move/100)
    report += "4ï¸âƒ£ **Earnings Move:**\n"
    report += f"- Â±{earnings_move:.2f}%: ${low:.2f} - ${high:.2f}ã€‚\nâ³ è´¢æŠ¥æ—¥å‰å1å‘¨ã€‚\n\n"

    report += "5ï¸âƒ£ **Vol Skew & RR:**\n"
    report += f"- Call IV: {call_iv:.2f}%, Put IV: {put_iv:.2f}%. RR: {vol_skew_rr:.2f}%ã€‚\n\n"

    report += "7ï¸âƒ£ **OI & Volume Profile å¯¹æ¯”:**\n"
    report += f"- Call æœ€å¤§ OI æ‰§è¡Œä»·: ${max_call:.2f}ï¼ŒPut æœ€å¤§ OI æ‰§è¡Œä»·: ${max_put:.2f}ã€‚\n"
    report += f"- POC: ${poc:.2f}, VAH: ${vah:.2f}, VAL: ${val:.2f}ã€‚\n"
    report += f"- å½“å‰è‚¡ä»·: ${current_price:.2f}ã€‚\n"
    if current_price > vah:
        report += "ğŸ‘‰ ä»·æ ¼é«˜äº VAHï¼Œå¯èƒ½çŸ­æœŸè¶…ä¹°ã€‚\n\n"
    elif current_price < val:
        report += "ğŸ‘‰ ä»·æ ¼ä½äº VALï¼Œå¯èƒ½çŸ­æœŸè¶…å–ã€‚\n\n"
    else:
        report += "ğŸ‘‰ ä»·æ ¼åœ¨ä»·å€¼åŒºé—´å†…ï¼Œå±äºæ­£å¸¸æ³¢åŠ¨ã€‚\n\n"

    expiry_date = (datetime.today()+timedelta(days=forecast_days)).strftime("%Y-%m-%d")
    report += "6ï¸âƒ£ **ä»·æ ¼é¢„æµ‹åŒºé—´:**\n"
    report += f"- {forecast_days}å¤©: ${low:.2f} - ${high:.2f} (è‡³ {expiry_date})ã€‚\n\n"

    report += f"ğŸ“Œ **ç»“è®º:** å¸‚åœº {'åå¤š' if vol_skew_rr>0 else 'åç©º'}ï¼Œå»ºè®®å¸ƒå±€ç›¸åº”ç­–ç•¥ã€‚"
    return report

# ================= Run Analysis =================
if st.sidebar.button("Run Analysis"):
    hist = stock.history(period="1d")
    if hist.empty:
        st.error("No historical data available. Check ticker.")
    else:
        current_price = hist["Close"].iloc[-1]
        option_chain = stock.option_chain(valuation_expiry)
        calls, puts = option_chain.calls, option_chain.puts
        max_oi_call = calls.loc[calls['openInterest'].idxmax()]
        max_oi_put = puts.loc[puts['openInterest'].idxmax()]
        st.write(f"**Call æœ€å¤§OIæ‰§è¡Œä»·:** {max_oi_call['strike']}")
        st.write(f"**Put æœ€å¤§OIæ‰§è¡Œä»·:** {max_oi_put['strike']}")

        data = fetch_stock_data(ticker)
        poc, vah, val, hist_v, edges = compute_volume_profile(data)
        if poc:
            st.write(f"[Volume Profile] POC: {poc:.2f}, VAH: {vah:.2f}, VAL: {val:.2f}")

        max_pain_prices = [current_price - 2 for _ in selected_expiries]
        pinning_probs = [0.012 for _ in selected_expiries]
        bs_call, bs_put = 7.43, 6.94
        earnings_move = 4.17
        vol_skew_rr, call_iv, put_iv = -13.09, 67.19, 80.27

        report = generate_option_report(ticker, selected_expiries, max_pain_prices, pinning_probs,
                                        bs_call, bs_put, earnings_move, vol_skew_rr,
                                        call_iv, put_iv, current_price, forecast_days)
        st.markdown(report)

        days = np.arange(0, forecast_days+1)
        max_pain_path = np.linspace(current_price, np.mean(max_pain_prices), len(days))
        bs_path = np.linspace(current_price, current_price * (1 + vol_skew_rr/200), len(days))
        avg_path = (max_pain_path + bs_path) / 2

        fig, ax = plt.subplots(figsize=(10, 6))
        ax.plot(days, max_pain_path, label="Max Pain Path")
        ax.plot(days, bs_path, label="BS Path")
        ax.plot(days, avg_path, label="Average Path", linestyle="--")
        ax.set_title("Price Anticipation Plot")
        ax.set_xlabel("Days")
        ax.set_ylabel("Price")
        ax.legend()
        st.pyplot(fig)
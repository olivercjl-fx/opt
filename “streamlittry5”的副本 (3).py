# -*- coding: utf-8 -*-
"""â€œstreamlittry5â€çš„å‰¯æœ¬

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1wa5UpSu_7ESCqll6iciUljYHncojNbGi
"""

import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from datetime import datetime, timedelta
from scipy.stats import norm
from scipy.optimize import fsolve, curve_fit

# ================= Streamlit Sidebar Inputs =================
st.sidebar.title("Options Analysis Dashboard")
ticker = st.sidebar.text_input("Ticker", value="AAPL")
expiry_count = st.sidebar.slider("Expiry Count", 1, 10, 3)
forecast_days = st.sidebar.slider("Forecast Days", 10, 90, 30)
E = st.sidebar.slider("E (Pinning)", 0.001, 0.05, 0.01)
opt_type = st.sidebar.selectbox("Option Type", ["Put", "Call"])

# Ensure ticker is valid before fetching data
if ticker:
    stock = yf.Ticker(ticker)
    try:
        expirations = stock.options
        st.sidebar.write("Available Expiries:", expirations)
        selected_expiries = st.sidebar.multiselect(
            "Select Expiries for Analysis", expirations, default=expirations[:expiry_count]
        )
        valuation_expiry = st.sidebar.selectbox("Select Expiry for Valuation", expirations)
    except Exception as e:
        st.error(f"Error fetching options data: {e}")
        selected_expiries, valuation_expiry = [], None
else:
    st.stop()

# ================= Option Strategy Builder =================
st.sidebar.subheader("Option Strategy Builder")
strategy = st.sidebar.selectbox("Select Strategy", ["Single Call", "Single Put", "Vertical Spread", "Straddle"])
strike_price = st.sidebar.number_input("Strike Price", min_value=1.0, value=100.0)
premium = st.sidebar.number_input("Option Premium", min_value=0.0, value=5.0)
if strategy == "Vertical Spread":
    strike_price_2 = st.sidebar.number_input("Second Strike Price", min_value=1.0, value=105.0)
    premium_2 = st.sidebar.number_input("Second Option Premium", min_value=0.0, value=3.0)
if st.sidebar.button("Build Option"):
    price_range = np.linspace(strike_price * 0.8, strike_price * 1.2, 100)
    payoff = None
    if strategy == "Single Call":
        payoff = np.maximum(price_range - strike_price, 0) - premium
    elif strategy == "Single Put":
        payoff = np.maximum(strike_price - price_range, 0) - premium
    elif strategy == "Vertical Spread":
        payoff = (
            np.maximum(price_range - strike_price, 0) - premium
        ) - (
            np.maximum(price_range - strike_price_2, 0) - premium_2
        )
    elif strategy == "Straddle":
        payoff = (
            np.maximum(price_range - strike_price, 0) - premium
        ) + (
            np.maximum(strike_price - price_range, 0) - premium
        )
    fig, ax = plt.subplots(figsize=(8, 4))
    ax.plot(price_range, payoff, label=strategy)
    ax.axhline(0, color='black', linestyle='--')
    ax.set_title(f"Payoff Diagram: {strategy}")
    ax.set_xlabel("Underlying Price")
    ax.set_ylabel("Profit / Loss")
    ax.legend()
    st.pyplot(fig)

# ================= Black-Scholes Pricing =================
def black_scholes_price(S, K, T, r, sigma, option_type='call'):
    d1 = (np.log(S / K) + (r + 0.5 * sigma ** 2) * T) / (sigma * np.sqrt(T))
    d2 = d1 - sigma * np.sqrt(T)
    if option_type.lower() == 'call':
        return S * norm.cdf(d1) - K * np.exp(-r * T) * norm.cdf(d2)
    return K * np.exp(-r * T) * norm.cdf(-d2) - S * norm.cdf(-d1)

# ================= Fetch & Volume Analysis =================
def fetch_stock_data(ticker, period="6mo", interval="1h"):
    df = yf.download(ticker, period=period, interval=interval)
    if df.empty:
        st.warning(f"[é”™è¯¯] æ— æ³•è·å– {ticker} æ•°æ®ã€‚")
        return pd.DataFrame()
    df.reset_index(inplace=True)
    return df

def compute_volume_profile(df, bins=50):
    if df.empty:
        return None, None, None
    hist, edges = np.histogram(df['Close'], bins=bins, weights=df['Volume'])
    poc = float((edges[np.argmax(hist)] + edges[np.argmax(hist) + 1]) / 2)
    total = hist.sum()
    sorted_idx = np.argsort(hist)[::-1]
    cum = np.cumsum(hist[sorted_idx])
    va_idx = sorted_idx[cum <= total * 0.7]
    va_prices = [(edges[i] + edges[i + 1]) / 2 for i in va_idx]
    return poc, float(max(va_prices)), float(min(va_prices))

# ================= Generate Detailed Report =================
def generate_option_report(
    ticker, expiries, max_pain_prices, pinning_probs,
    bs_call, bs_put, earnings_move, vol_skew_rr,
    call_iv, put_iv, current_price,
    poc, vah, val, max_call, max_put,
    forecast_days=30
):
    report = f"ğŸ“Š **Option Market Analysis Report: {ticker}**

"
    avg_max_pain = float(np.mean(max_pain_prices))
    expiry_str = ", ".join(expiries)
    low_move = current_price * (1 - earnings_move/100)
    high_move = current_price * (1 + earnings_move/100)
    forecast_low = min(avg_max_pain, low_move)
    forecast_high = max(avg_max_pain, high_move)

    # 1ï¸âƒ£ Max Pain
    report += "1ï¸âƒ£ **Max Pain (æœ€å¤§ç—›ç‚¹ä»·):**
"
    report += f"- ç—›ç‚¹ä»·åˆ—è¡¨: {[float(x) for x in max_pain_prices]} ï¼Œå½“å‰: ${current_price:.2f}
"
    report += f"- å¹³å‡ç—›ç‚¹ä»·: ${avg_max_pain:.2f} ï¼Œå½“å‰: ${current_price:.2f}
"
    if current_price > avg_max_pain:
        report += f"  â†³ è‚¡ä»·ï¼ˆ${current_price:.2f}ï¼‰é«˜äºå¹³å‡ç—›ç‚¹ä»·ï¼ˆ${avg_max_pain:.2f}ï¼‰ï¼ŒçŸ­æœŸåç©ºã€‚

"
    elif current_price < avg_max_pain:
        report += f"  â†³ è‚¡ä»·ï¼ˆ${current_price:.2f}ï¼‰ä½äºå¹³å‡ç—›ç‚¹ä»·ï¼ˆ${avg_max_pain:.2f}ï¼‰ï¼ŒçŸ­æœŸåå¤šã€‚

"
    else:
        report += f"  â†³ è‚¡ä»·ï¼ˆ${current_price:.2f}ï¼‰ç­‰äºå¹³å‡ç—›ç‚¹ä»·ï¼Œä¿¡å·ä¸­æ€§ã€‚

"

    # 2ï¸âƒ£ é’‰ä½æ¦‚ç‡
    report += "2ï¸âƒ£ **é’‰ä½æ¦‚ç‡ (Pinning Probability):**
"
    for e, p in zip(expiries, pinning_probs):
        report += f"- åˆ°æœŸæ—¥ {e} é’‰ä½ä»·ä½æ¦‚ç‡: {p*100:.2f}% ï¼Œå½“å‰: ${current_price:.2f}
"
    report += f"  â†³ è‚¡ä»·ï¼ˆ${current_price:.2f}ï¼‰æ¥è¿‘é«˜æ¦‚ç‡åŒºé—´ï¼Œæ˜“è¢«é’‰ä½ã€‚

"

    # 3ï¸âƒ£ Black-Scholes å®šä»·
    report += "3ï¸âƒ£ **Black-Scholes å®šä»·:**
"
    report += f"- Call ä¼°å€¼: ${bs_call:.2f} ï¼Œå½“å‰: ${current_price:.2f}
"
    report += f"- Put ä¼°å€¼: ${bs_put:.2f} ï¼Œå½“å‰: ${current_price:.2f}
"
    report += f"  â†³ ä¼°å€¼ä¸å¸‚ä»·å¯¹æ¯”: {'é«˜äº' if current_price<bs_call else 'ä½äº'} Call ä¼°å€¼ï¼Œ{'çœ‹å¤š' if current_price<bs_call else 'çœ‹ç©º'}ã€‚

"

    # 4ï¸âƒ£ è´¢æŠ¥é¢„æœŸåŒºé—´
    report += "4ï¸âƒ£ **è´¢æŠ¥é¢„æœŸåŒºé—´ (Earnings Expected Move):**
"
    report += f"- åŒºé—´: ${low_move:.2f} - ${high_move:.2f} (Â±{earnings_move:.2f}%)
"
    report += f"  â†³ å½“å‰: ${current_price:.2f}ï¼Œ{'åœ¨' if low_move<=current_price<=high_move else 'è¶…å‡º'}é¢„æœŸåŒºé—´ã€‚

"

    # 5ï¸âƒ£ æ³¢åŠ¨ç‡åæ–œ & é£é™©é€†è½¬
    report += "5ï¸âƒ£ **æ³¢åŠ¨ç‡åæ–œ & é£é™©é€†è½¬ (Vol Skew & RR):**
"
    report += f"- Call IV: {call_iv:.2f}%ï¼ŒPut IV: {put_iv:.2f}%ï¼ŒRR: {vol_skew_rr:.2f}%
"
    if vol_skew_rr > 0:
        report += f"  â†³ RR æ­£å‘ ({vol_skew_rr:.2f}%)ï¼Œå¸‚åœºåå¤šã€‚

"
    elif vol_skew_rr < 0:
        report += f"  â†³ RR è´Ÿå‘ ({vol_skew_rr:.2f}%)ï¼Œå¸‚åœºåç©ºã€‚

"
    else:
        report += "  â†³ RR æ¥è¿‘ 0ï¼Œå¸‚åœºä¸­æ€§é¢„æœŸã€‚

"

    # 6ï¸âƒ£ OI & Volume Profile
    report += "6ï¸âƒ£ **OI & æˆäº¤é‡åˆ†å¸ƒ (Volume Profile):**
"
    report += f"- Call æœ€å¤§ OI æ‰§è¡Œä»·: ${max_call:.2f} ï¼Œå½“å‰: ${current_price:.2f}
"
    report += f"- Put æœ€å¤§ OI æ‰§è¡Œä»·: ${max_put:.2f} ï¼Œå½“å‰: ${current_price:.2f}
"
    report += f"- POC: ${poc:.2f}, VAH: ${vah:.2f}, VAL: ${val:.2f} ï¼Œå½“å‰: ${current_price:.2f}
"
    if current_price > vah:
        report += f"  â†³ ä»·æ ¼è¶…å‡ºä»·å€¼åŒºä¸Šæ²¿ï¼ˆ${vah:.2f}ï¼‰ï¼Œè¿‡çƒ­é£é™©ã€‚

"
    elif current_price < val:
        report += f"  â†³ ä»·æ ¼è·Œç ´ä»·å€¼åŒºä¸‹æ²¿ï¼ˆ${val:.2f}ï¼‰ï¼Œè¶…å–æœºä¼šã€‚

"
    else:
        report += f"  â†³ ä»·æ ¼åœ¨ä»·å€¼åŒºå†…éƒ¨ï¼ˆ${val:.2f}-${vah:.2f}ï¼‰ï¼Œæ­£å¸¸æ³¢åŠ¨ã€‚

"

    # 7ï¸âƒ£ ç»¼åˆé¢„æµ‹åŒºé—´
    report += "7ï¸âƒ£ **ç»¼åˆé¢„æµ‹åŒºé—´:**
"
    report += f"- ${forecast_low:.2f} - ${forecast_high:.2f} (è‡³ {(datetime.today()+timedelta(days=forecast_days)).strftime('%Y-%m-%d')}) ï¼Œå½“å‰: ${current_price:.2f}
"
    report += f"  â†³ å½“å‰è‚¡ä»· {'ä½äº' if current_price<forecast_low else 'é«˜äº' if current_price>forecast_high else 'åœ¨'}é¢„æµ‹åŒºé—´ã€‚

"

    # ç»“è®º
    direction = 'åå¤š' if vol_skew_rr>0 else 'åç©º'
    report += f"ğŸ“Œ **ç»¼åˆç»“è®º:** å¸‚åœº{direction}ï¼Œå»ºè®®ä¸Šæ²¿/ç—›ç‚¹ï¼ˆ${forecast_high:.2f}ï¼‰å¸ƒå±€é˜²å¾¡ï¼Œä¸‹æ²¿/ä»·å€¼åŒºä¸‹æ²¿ï¼ˆ${forecast_low:.2f}ï¼‰å¸ƒå±€è¿›æ”»ã€‚"
    return report

# ================= Run Analysis =================
if st.sidebar.button("Run Analysis"):
    hist = stock.history(period='1d')
    if hist.empty:
        st.error("æ— å†å²æ•°æ®ã€‚")
    else:
        current_price = float(hist['Close'].iloc[-1])
        chain = stock.option_chain(valuation_expiry)
        calls, puts = chain.calls, chain.puts
        max_call = float(calls.loc[calls['openInterest'].idxmax()]['strike'])
        max_put = float(puts.loc[puts['openInterest'].idxmax()]['strike'])
        df = fetch_stock_data(ticker)
        poc, vah, val = compute_volume_profile(df)
        max_pain_prices = [float(current_price)] * len(selected_expiries)
        pinning_probs = [0.012] * len(selected_expiries)
        bs_call = black_scholes_price(current_price, strike_price, forecast_days/252, 0.03, 0.2)
        bs_put = black_scholes_price(current_price, strike_price, forecast_days/252, 0.03, 0.2, 'put')
        earnings_move = 4.17
        vol_skew_rr, call_iv, put_iv = -13.09, 67.19, 80.27

        report = generate_option_report(
            ticker, selected_expiries, max_pain_prices, pinning_probs,
            bs_call, bs_put, earnings_move, vol_skew_rr,
            call_iv, put_iv, current_price,
            poc, vah, val, max_call, max_put,
            forecast_days
        )
        st.markdown(report)

        # Plot Anticipation with Bounds
        days = np.arange(0, forecast_days+1)
        avg_max_pain = float(np.mean(max_pain_prices))
        low_move = current_price * (1 - earnings_move/100)
        high_move = current_price * (1 + earnings_move/100)
        forecast_low = min(avg_max_pain, low_move)
        forecast_high = max(avg_max_pain, high_move)
        max_path = np.linspace(current_price, avg_max_pain, len(days))
        bs_path = np.linspace(current_price, current_price*(1+vol_skew_rr/200), len(days))
        avg_path = (max_path + bs_path) / 2

        fig, ax = plt.subplots(figsize=(10, 6))
        ax.plot(days, max_path, label="Max Pain Path")
        ax.plot(days, bs_path, label="BS Path")
        ax.plot(days, avg_path, linestyle='--', label="Average Path")
        ax.hlines([forecast_low, forecast_high], 0, forecast_days, linestyles='dotted', label='Forecast Bounds')
        ax.set_title("Price Anticipation Plot with Bounds")
        ax.set_xlabel("Days")
        ax.set_ylabel("Price")
        ax.legend()
        st.pyplot(fig)